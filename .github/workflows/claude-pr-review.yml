name: Claude Auto Review with Tracking
on:
  pull_request:
    types: [opened, synchronize] # ready_for_review, reopened

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY_CODE_REVIEW }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Review Objectives

            Review this pull request comprehensively for security vulnerabilities, code quality, and best practices.
            Rate each finding with severity: CRITICAL, HIGH, MEDIUM, or LOW.

            ## Workflow

            1. First, run `gh pr diff` to read and understand all changes in this PR
            2. Review the diff against the security and quality checks below
            3. Post inline comments for specific issues found
            4. Post a summary comment with overall assessment

            ## Security Checks (Priority)

            1. Authentication & Authorization
               - No broken authentication mechanisms
               - No broken access control
               - Proper session management

            2. Injection Vulnerabilities
               - No SQL injection (parameterized queries required)
               - No XSS (Cross-Site Scripting)
               - No XXE (XML External Entity attacks)
               - No command injection
               - No unsafe deserialization

            3. Data Protection
               - No hardcoded credentials, API keys, or secrets
               - No sensitive data or PII in logs
               - No sensitive data exposed in error messages
               - Input validation implemented for all user inputs
               - Secure cryptographic practices (no weak algorithms)

            4. Security Controls
               - No CSRF vulnerabilities
               - No security misconfigurations
               - No components with known vulnerabilities
               - Proper error handling without information disclosure

            5. Concurrency & Logic
               - No race conditions or TOCTOU issues
               - Thread-safe operations where applicable

            ## Code Quality Checks

            - DRY principle followed (no unnecessary duplication)
            - Associated documentation updated
            - changelog.md updated (if applicable)
            - Proper error handling with appropriate logging
            - Sufficient logging and monitoring for critical operations
            - Performance considerations addressed

            ## Severity Guidelines

            - CRITICAL: Exploitable security vulnerability, data breach risk, authentication bypass
            - HIGH: Security issue requiring immediate attention, significant bug, major performance issue
            - MEDIUM: Code quality issue, minor security concern, maintainability problem
            - LOW: Style issue, minor refactoring suggestion, documentation improvement

            ## Output Format

            Use inline comments (mcp__github_inline_comment__create_inline_comment) for specific code issues.
            Format each finding as:
            [SEVERITY] Brief description
            Details and recommendation

            Use `gh pr comment` for summary feedback including:
            - Overall security posture
            - Count of findings by severity
            - Top priority items to address
            - Brief acknowledgment of good practices observed (if any)

            If no issues are found:
            - Post a summary comment confirming the PR passes all checks
            - Briefly note any particularly good practices observed

            Note: The PR branch is already checked out in the current working directory.
            Only post GitHub comments - don't submit review text as messages.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"