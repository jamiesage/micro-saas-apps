name: Claude Auto Review with Tracking
on:
  pull_request:
    types: [opened, synchronize] # ready_for_review, reopened

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2

      # Pre-fetch the diff (free, no AI tokens)
      - name: Get PR Diff
        id: diff
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr_diff.txt
          # Truncate if too large (prevents huge PRs from inflating costs)
          head -c 100000 /tmp/pr_diff.txt > /tmp/pr_diff_truncated.txt
          # Save list of changed files for selective reading if needed
          gh pr diff ${{ github.event.pull_request.number }} --name-only > /tmp/changed_files.txt
        env:
          GH_TOKEN: ${{ github.token }}

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY_PR_REVIEW }}
          track_progress: false
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Review Objectives

            Review this pull request comprehensively for security vulnerabilities, code quality, and best practices.
            Rate each finding with severity: CRITICAL, HIGH, MEDIUM, or LOW.

            ## Workflow

            1. Read the pre-fetched diff from /tmp/pr_diff_truncated.txt
            2. Review the diff against the security and quality checks below
            3. If you need additional context, you may read up to 5 key files from the changed files
            4. Submit a single PR review with all findings using `gh pr review`

            ## Efficiency Guidelines

            - Complete your review in 5 or fewer tool calls
            - Limit full file reads to 5 key files maximum
            - Only read full files if the diff doesn't provide enough context for security assessment
            - Prefer analyzing the diff over reading complete files
            - Changed files list is available in /tmp/changed_files.txt
            - Skip: go.sum, package-lock.json, lock files, vendored dependencies
            - For large PRs (>500 changed lines), prioritize CRITICAL and HIGH severity issues
            - Submit ONE review with all findings - do not make multiple comments

            ## Security Checks (Priority)

            1. Authentication & Authorization
               - No broken authentication mechanisms
               - No broken access control
               - Proper session management

            2. Injection Vulnerabilities
               - No SQL injection (parameterized queries required)
               - No XSS (Cross-Site Scripting)
               - No XXE (XML External Entity attacks)
               - No command injection
               - No unsafe deserialization

            3. Data Protection
               - No hardcoded credentials, API keys, or secrets
               - No sensitive data or PII in logs
               - No sensitive data exposed in error messages
               - Input validation implemented for all user inputs
               - Secure cryptographic practices (no weak algorithms)

            4. Security Controls
               - No CSRF vulnerabilities
               - No security misconfigurations
               - No components with known vulnerabilities
               - Proper error handling without information disclosure

            5. Concurrency & Logic
               - No race conditions or TOCTOU issues
               - Thread-safe operations where applicable

            ## Code Quality Checks

            - DRY principle followed (no unnecessary duplication)
            - Associated documentation updated
            - changelog.md updated (if applicable)
            - Proper error handling with appropriate logging
            - Sufficient logging and monitoring for critical operations
            - Performance considerations addressed

            ## Severity Guidelines

            - CRITICAL: Exploitable security vulnerability, data breach risk, authentication bypass
            - HIGH: Security issue requiring immediate attention, significant bug, major performance issue
            - MEDIUM: Code quality issue, minor security concern, maintainability problem
            - LOW: Style issue, minor refactoring suggestion, documentation improvement

            ## Output Format

            Submit ONE PR review using `gh pr review` with all findings in a single review body.

            Format your review body as:

            ## Security Review Summary

            **Overall Assessment:** [PASS/NEEDS ATTENTION/CRITICAL ISSUES]

            ### Findings by Severity
            - CRITICAL: X issues
            - HIGH: X issues
            - MEDIUM: X issues
            - LOW: X issues

            ### Detailed Findings

            For each issue found:
            **[SEVERITY]** Brief description
            - File: `path/to/file.go:line`
            - Details: Explanation of the issue
            - Recommendation: How to fix it

            ### Good Practices Observed
            - Note any particularly good practices

            If no issues are found, confirm the PR passes all checks.

            Use this command to submit the review:
            gh pr review ${{ github.event.pull_request.number }} --comment --body "YOUR REVIEW HERE"

            Do NOT use multiple tool calls - submit everything in ONE review.

          claude_args: |
            --max-turns 15
            --allowedTools "Bash(cat /tmp/*.txt),Bash(cat apps/**/*),Bash(gh pr review:*)"